Option Explicit

Function get_Response(Prompt As String) As Variant
Dim API_Key As String
Dim temp As Variant
Dim Model As Integer
Dim File_Found As Boolean


API_Key = ""

If Settings.Range("D3") = "gpt-4" Then
    Model = 1
End If

Prompt = URLEncode(Prompt)

temp = Send_Req_Win(API_Key, Prompt, Model)

If InStr(temp, "Incorrect API key provided") > 0 Then
    MsgBox "Incorrect API key provided.", vbExclamation, "Invalid!"
    End
ElseIf InStr(temp, "Model response exceeds maximum token limit") > 0 Then
    MsgBox "API Token Limit exceeded.", vbExclamation, "Limit exceeded!"
    End
ElseIf InStr(temp, "content" & Chr(34) & ":") > 0 Then
    get_Response = Split_Content(temp)
Else
    MsgBox temp, vbExclamation
    End
End If

End Function




Sub SendHttpRequest()
    Dim xmlhttp As Object
    Dim url As String
    Dim apiKey As String
    Dim postData As String

    
    apiKey = "AIzaSyDsgU88aODi3lyOrWVCqki0vLVJ03Di44o"
    ' Define the URL and API key
    url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=" & apiKey

    ' JSON data to be sent in the request
    postData = "{""contents"":[{""parts"":[{""text"":""Explain how AI works""}]}]}"

    ' Create the XMLHttpRequest object
    Set xmlhttp = CreateObject("MSXML2.XMLHTTP.6.0")
    
    ' Configure the request
    xmlhttp.Open "POST", url, False
    xmlhttp.setRequestHeader "Content-Type", "application/json"
    
    ' Send the request
    xmlhttp.send postData
    
    ' Check the status of the request
    If xmlhttp.Status = 200 Then
        MsgBox "Request sent successfully!" & vbCrLf & "Response: " & xmlhttp.responseText
    Else
        MsgBox "Error " & xmlhttp.Status & ": " & xmlhttp.statusText
    End If
    
    ' Clean up
    Set xmlhttp = Nothing
End Sub





Function Split_Content(str As Variant)

Dim Temp1 As Variant
Dim I As Long


Temp1 = Split(str, Chr(34) & "content" & Chr(34) & ": ")(1)
Temp1 = Split(Temp1, "},")(0)
Temp1 = Replace(Temp1, Chr(34), "")
Temp1 = Replace(Temp1, "\n", Chr(10))
Temp1 = Replace(Temp1, "\", "")

Split_Content = Temp1

End Function




Function Send_Req_Win(Key As String, str As String, Model As Integer)
Dim http_obj As Object
Dim Cmd As String
Dim url As String
Dim temperature As Double
Dim top_p As Double

With Settings
    temperature = 0.7
    top_p = 0.8
End With

Set http_obj = CreateObject("MSXML2.XMLHTTP")
url = "https://api.openai.com/v1/chat/completions"
If Model = 1 Then
    Cmd = "{""model"": ""gpt-4"",""messages"": [{""role"": ""system"", ""content"": """ & "Bible Scholar" & """},{""role"": ""user"", ""content"": """ & str & """}],""temperature"": " & temperature & ",""top_p"": " & top_p & "}"
ElseIf Model = 0 Then
    Cmd = "{""model"": ""gpt-3.5-turbo"",""messages"": [{""role"": ""system"", ""content"": """ & "Bible Scholar" & """},{""role"": ""user"", ""content"": """ & str & """}],""temperature"": " & temperature & " ,""top_p"": " & top_p & "}"
End If

http_obj.Open "POST", url, False
http_obj.setRequestHeader "Content-Type", "application/json"
http_obj.setRequestHeader "Authorization", "Bearer " & Key
http_obj.send Cmd
Send_Req_Win = http_obj.responseText

End Function




